clone_depth: 50

image:
  - Visual Studio 2017
  - Ubuntu

cache:
  - C:\CCACHE
  - /var/cache/pacman/pkg/

environment:
  global:
    MONOLITHIC: no
    TESTS_REDUCED_KEYLENGTHS: yes
    TZ: Europe/Zurich
    arch: x86_64
    bits: 64
  matrix:
    - TEST: all
    - TEST: all
      MONOLITHIC: yes
    - TEST: coverage
    - TEST: all
      LEAK_DETECTIVE: yes
    - TEST: all
    - TEST: all
      MONOLITHIC: yes
    - TEST: coverage
    - TEST: all
      LEAK_DETECTIVE: yes
    - TEST: botan
    - TEST: openssl
    - TEST: openssl
      LEAK_DETECTIVE: yes
    - TEST: gcrypt
    - TEST: gcrypt
      LEAK_DETECTIVE: yes
    - TEST: apidoc
      MONOLITHIC: no
    - TEST: win64
      MONOLITHIC: yes
    - TEST: wintun
      MONOLITHIC: yes
    - TEST: printf-builtin
      MONOLITHIC: yes

matrix:
  fast_finish: true
  exclude:
    - image: Ubuntu
      TEST: wintun
    - image: Visual Studio 2017
      TEST: botan
    - image: Visual Studio 2017
      TEST: gcrypt
    - image: Visual Studio 2017
      TEST: openssl
    - image: Visual Studio 2017
      TEST: apidoc
    - image: Visual Studio 2017
      TEST: coverage
    - image: Visual Studio 2017
      TEST: all
      MONOLITHIC: no

# Don't build if it's a push with a tag
skip_tags: true

for:
- matrix:
    only:
      - image: Ubuntu
  install:
    - sudo apt-get update -qq
    - sudo apt-get install -qq bison flex gperf gettext libgmp-dev libssl-dev libgcrypt11-dev
  build_script:
    - ./scripts/test.sh deps
    - ./scripts/test.sh pydeps
    - sudo sysctl -w net.ipv6.conf.all.disable_ipv6=0 || true
  test_script:
    - ./scripts/test.sh
  build_cloud: osboxes Docker

- matrix:
    only:
      - image: Visual Studio 2017
  build_script:
    - '%MSYS_SH% --login -c ". /etc/profile && cd $APPVEYOR_BUILD_FOLDER && ./scripts/test.sh deps"'
  test_script:
    - '%MSYS_SH% --login -c ". /etc/profile && cd $APPVEYOR_BUILD_FOLDER && ./scripts/test.sh"'
  install:
    - set CCACHE_DIR=C:\CCACHE
    - set MSYS_SH=C:\msys%BITS%\usr\bin\sh.exe
    - set MSYSTEM=MINGW%BITS%
    - set TEST=win%BITS%